# 前端性能优化——页面静态资源

## JavaScript

### 1. 减少不必要的请求

#### 1.1 代码拆分（code split）

相当于按需加载代码，不用一次就把可能用不到的组件也都加载过来

常见的有基于路由的代码拆分

#### 1.2 代码合并

将零散的小文件请求合并成一个请求，如雪碧图，以减少网络请求

### 2. 减少包体大小

#### 2.1 代码压缩

- gzip

#### 2.2 Tree Shaking

检测源码中不会用到的部分，将其删除，从而减小代码体积

- 静态分析，所有依赖可以在编译期确定
- 所以 Tree Shaking 只能分析ESM规范的模块
  - 要求所有的导入导出语句只能出现在模块顶层，且导入导出的模块名必须为字符串常量
  - ES6模块依赖关系是确定的，和运行时的状态无关，可以进行可靠的静态分析，这就是tree-shaking的基础。
  - 动态require一个模块，只有执行后才知道引用的什么模块，这个就不能通过静态分析去做优化
- 只处理函数和顶层的import/export变量，不能把没用到的类的方法消除掉

##### Tree Shaking 原理

Tree-shaking 的实现一是先**标记**出模块导出值中哪些没有被用过，二是使用 Terser 删掉这些没被用到的导出语句。标记过程大致可划分为三个步骤：

- Make 阶段，收集模块导出变量并记录到模块依赖关系图 ModuleGraph 变量中
- Seal 阶段，遍历 ModuleGraph 标记模块导出变量有没有被使用
- 生成产物时，若变量没有被其它模块使用则删除对应的导出语句

#### 2.4 优化polyfill的使用

#### 2.5 使用webpack时优化依赖包的引入



### 3. 解析与执行

- 优化代码，删掉不必要的代码
- 避免long task



## CSS

### 1. 优化资源请求

- 按需加载
- 合并文件
- 请求优先级排序

#### 慎用@import

- 会将请求变得串行化，执行到这个语句才会去请求这个css文件
- 使用<link /> 将css请求并行执行



### 2. 减少包的大小

- gzip压缩

### 3. 解析与渲染树构建

- 简化选择器，避免深层嵌套

**避免使用昂贵的属性**

- 有一些 CSS 的属性在渲染上是有比较高的成本的，渲染速度相较而言也会慢些。在不同的浏览器上，具体的表现不太一致，但总体来说，下面一些属性是比较昂贵的：
  - border-radius
  - box-shadow
  - opacity
  - transform
  - filter
  - position: fixed



## 图片

### 优化请求数

#### 1. 雪碧图

- 减少图片请求数量

#### 2. 懒加载

- 监听页面滚动，判断图片是否进入视野，从而真正去加载图片
- 在使用懒加载时也有一些注意点：
  - 首屏可以不需要懒加载，对首屏图片也使用懒加载会延迟图片的展示。
  - 设置合理的占位图，避免图片加载后的页面“抖动”。
  - 虽然目前基本所有用户都不会禁用 JavaScript，但还是建议做一些 JavaScript 不可用时的 backup。

#### 3. 内联 base64

体积会增大约33%，适用于小图标



### 减小图片大小

- 使用合适的图片格式
- 图片质量权衡（有损压缩）

