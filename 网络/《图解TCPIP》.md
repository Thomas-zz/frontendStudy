# 《图解TCP/IP》

## 一、网络基础知识

### 1.1 传输方式的分类

#### 1.1.1 面向有连接和面向无连接

- 面向有连接型
  - TCP
  - 在发送数据之前要在收发主机之间连接一条通信线路
  - 缺点：
    - 为了建立与断开连接，有时需要至少7次的发包收包，导致网络流量的浪费
    - 为了提高网络的利用率，定义里各种各样复杂的规范，因此不利于视频会议（音、视频数据量既定）
- 面向无连接型
  - UDP
  - 不要求建立和断开连接，发送端可于任何时候发送数据，接收端也不知道会从哪里收到数据

#### 1.1.2 电路交换与分组交换

- 电路交换：独占线路，期间其他计算机不能使用该线路
- 分组交换：将数据分组发送，收到分组数据后重新装配成完整的报文。
  - 计算机将数据分组->路由器->将分组数据缓存到自己的缓冲区->转发给目标计算机->目标计算机装配分组数据

#### 1.1.3 根据接收端数量分类

- 单播    1对1
- 广播    同一数据链路内的所有计算机
- 多播    1对n，（限定接收端，特定的组内通信
- 任播    1对1，（在特定的多台主机中选择1台



### 1.2 地址

#### 1.2.1 地址的唯一性和层次性

- 唯一性：在同一个通信网络中不允许有两个相同地址的通信主体存在
- 层次性：
  - ip地址具有层次性
    - IP地址=网络号+主机号
    - IP寻址：路由控制表（路由器中）
  - MAC地址没有层次性 
    - MAC寻址：地址转发表（交换机中）

## 二、TCP/IP基础知识

### 2.1 TCP/IP协议分层模型

#### <img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210605150546194.png" alt="image-20210605150546194" style="zoom:80%;" />

### 2.2 TCP/IP分层模型与通信示例

#### 2.2.1 数据包首部

> 帧用于表示数据链路层中包的单位。而数据包是IP和UDP等网络层以上的分层中包的单位。段则表示TCP数据流中的信息。消息是指应用协议中数据的单位

#### 2.2.2 发送数据包

1. 应用程序处理
2. TCP模块的处理
   - 添加TCP首部，包括源端口号和目标端口号、序号以及校验和（用于判断数据是否损坏）
3. IP模块的处理
   - 添加IP首部，包含接收端IP地址以及发送端IP地址，和用来判断其后面是TCP还是UDP的信息
4. 网络接口（以太网驱动）的处理
   - 添加以太网首部并进行发送处理。包含接收端MAC地址、发送端MAC地址以及标志以太网类型的以太网数据的协议

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210605151907433.png" alt="image-20210605151907433" style="zoom:70%;" />

#### 2.2.3 数据包接受处理

1. 网络接口（以太网驱动）的处理
   - 根据包首部MAC地址判断是否为发给自己的包
2. IP模块的处理
   - 判断IP地址是否和自己的IP地址匹配
   - 将IP包首部之后的部分传给对应协议处理，如TCP，UDP
3. TCP模块的处理
   1. 计算校验和，判断数据是否被破坏
   2. 检查是否在按照序号接收数据
   3. 检查端口号，确定具体的应用程序
   4. 发送一个“确认回执”给发送端。若此回执未能达到发送端，那么发送端会认为接收端没有收到数据而一直反复发送
   5. 数据被完整接收后，传给由端口号识别的应用程序
4. 应用程序的处理



## 三、数据链路

网络的连接诶和构成的形态称为网络拓扑

### 3.2 数据链路相关技术

#### 3.2.1 MAC地址

MAC地址用于识别**数据链路**中互相连接的节点。

MAC地址用来标识同一个链路中不同计算机的一种识别码

- MAC地址长48比特，任何一个网卡的MAC地址都是唯一的，全世界不会重复
- 例外情况：一台主机上如果启动多个虚拟机，由于没有硬件的网卡只能由虚拟软件自己设定MAC地址给多个虚拟网卡
- 以太网交换机就是持有多个端口的网桥

> **传输速度与计算机内部的表现值**
>
>   计算机内部采用二进制，因此以2^10表示最接近于1000的值，于是有：
>
> - 1K = 1024
> - 1M = 1024K
> - 1G = 1024M
>
>   而以太网中以时钟频率决定传输速度，以下等式请不要与上面的混淆：
>
> - 1K = 1000
> - 1M = 1000K
> - 1G = 1000M



## 四、IP协议

### 4.1 IP即网际协议

IP(Internet Protocol)

- IP相当于OSI参考模型的第三层（网络层）
- 主要作用：在复杂的网络环境中将数据包发送给最终的目标地址

> **主机与节点**
>
> 习惯上将配有IP地址的设备称为“主机”。准确的说，主机是指“配置有IP地址，但是不进行路由控制的设备”。既培优IP地址又具有路由控制能力的设备叫“路由器”。
>
> 节点则是主机和路由器的统称

#### 4.1.1 网络层与数据链路层的关系

- 数据链路层提供直连两个设备之间的通信功能
- 网络层的IP负责在没有直连的两个网络之间进行通信传输

### 4.2 IP 基础知识

IP地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”

- IP面向无连接
  - 简单化
  - 高速化
- TCP采用有连接
  - 可靠性

#### 4.2.1 路由控制

路由控制是指将分组数据发送到最终目标地址的功能

- Hop译为跳，IP包是在网络中一个个跳间被转发，因此IP路由也叫多跳路由
- 每一区间（跳）在转发IP数据包时会分别制定下一跳的操作，直到包最终达到目的地
- 也就是说，每个路由器只会告诉包，你下一站该去哪，而不是你要怎么走才能到目的地

**路由控制表**

所有主机都维护着一张路由控制表，该表记录IP数据在下一步应该发给哪个路由器

### 4.3 IP地址的基础知识

#### 4.3.1 IP地址的定义

- IPv4地址由32位正整数表示，IP地址在计算机内以二进制方式被处理

> IP地址并非根据主机台数来配置，而是每一台主机上的每一块网卡（NIC）都得设置IP地址，且一块网卡可配置多个地址（通常一个）

#### 4.3.2 IP地址由网络和主机两部分标识组成

- 网络标识必须保证相互连接的每个段的地址不重复，相同段内相连的主机必须有相同的网络地址
- 主机标识不允许在同一个网段内重复出现
- 区分方法：
  - 分类（老方法）
    - A类：首位以“0”开头的地址，第1-8位是它的网络标识，后24位相当于主机标识
    - B类：首位以“10”开头的地址，第1-16位是它的网络标识，后16位相当于主机标识
    - C类：首位以“110”开头的地址，第1-24位是它的网络标识，后8位相当于主机标识
    - D类：首位以“1110”开头的地址，第1-32位是它的网络标识，没有主机标识，常用于多播
  - 子网掩码（网络前缀）

#### 4.3.3 广播地址

用于在同一个链路中相互连接的主机之间发送数据包。

- 将IP地址中的主机地址部分全部设置为1，就成了广播地址
- 两种广播
  - 本地广播：在本网络内的广播
  - 直接广播：在不同网络之间的广播



#### 4.3.4 IP多播

用于将包发送给特定组内的所有主机，直接使用IP协议，不存在可靠传输

- 使用D类地址，所以以“1110”开头的地址就可以认为是多播地址



#### 4.3.5 子网掩码

**背景**

网络标识相同的计算机必须同属于一个链路，然而在实际网络架构当中，直接使用A类或B类地址会有些浪费（因为如B类IP网络理论上一个链路内允许6万5千多态计算机连接，但一般不会有在同一个链路上连接6万5千多态计算机的情况）

- 子网掩码可以灵活的指定网络标识的长度，由此一个IP地址可以不受限于自己的类别，自由地定位自己网络标识的长度
- 引入子网后，一个IP地址就有了两种识别码。一是IP地址本身，另一个是表示网络部的子网掩码
- 子网掩码的两种表示方法：
  - <img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210608205010450.png" alt="image-20210608205010450" style="zoom:50%;" />
  - <img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210608205043547.png" alt="image-20210608205043547" style="zoom:65%;" />



#### 4.3.6 私有IP与全局IP

全局IP地址基本上要在整个互联网范围内保持唯一，但私有地址不需要，只要在同一个域里保证唯一即可



### 4.4 路由控制

路由控制表的形成方式：

- 静态路由控制：管理员手动设置
- 动态路由控制：路由器与其他路由器相互交换信息时自动刷新

#### 4.4.1 IP地址与路由控制

首先确定IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址（若有多条，则选择最吻合的）的记录，根据该记录将IP包转发给相应的下一个路由器

- 默认路由：一般为0.0.0.0/0，指路由表中任何一个地址都能与之匹配的记录  
- 主机路由：“IP地址/32”，整个IP地址的所有位都将参与路由
- 环回地址：127.0.0.1，同一台计算机上的程序之间进行网络通信时所用的一个默认地址



### 4.5 IP分割处理与再构成处理

因为每种数据链路的最大传输单元（MTU）都不尽相同，如以太网的默认MTU是1500字节，因此大于1500字节的IP数据报无法在一个帧当中发送完成，就需要分片处理。

- 路由器进行IP报文的分片，目标主机进行重组

#### 4.5.1 路径MTU发现

分片机制会导致路由器处理负荷加重，且随着网络安全要求的提高，路由器要做的处理越来越多。

- MTU即Maximum Transmission Unit 最大传输单元。指一种通信协议的某一层上面所能通过的最大数据包大小（以字节为单位）

- 简单来说就是找到路径上的不需要分片就能发送的最大MTU，即路径中存在的所有数据链路中最小的MTU
- 由主机对数据报进行分片处理
- 在TCP中采用路径MTU发现，则IP层不会再进行分片处理，且不需要重组



### 4.6 IPv6

长度为128比特，一般以16比特为1组，分成8组，每组用冒号“:”隔开进行标记。如果出现连续的0时还可以将这些0省略，并用两个冒号“::”隔开。但一个IP地址中只允许出现一次两个连续的冒号

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210610093229273.png" alt="image-20210610093229273" style="zoom:50%;" />

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210610093518850.png" alt="image-20210610093518850" style="zoom:50%;" />

- IPv6的分片处理只在作为起点的发送端主机上进行，路由器不参与分片

### 4.7 IPv4首部

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210610093827328.png" alt="image-20210610093827328" style="zoom:80%;" />

- 版本：4bit 表示表示IP首部的版本号

- 首部长度：4bit，表明IP首部大小，单位为4字节，如首部长度设置为“5”，IP首部的长度为4 * 5 = 10字节

- 区分服务：8bit 用来表明服务质量，不常用

- 总长度：表示IP首部与数据部分合起来的总字节数。该字段长16比特，因此IP包的最大长度为65535(=2^16)字节

- 标识（ID）：由16比特构成，用于分片重组，同一个分片的标识值相同，不同分片的标识值不同。即便ID相同，如果目标地址、源地址或协议不同的话，也认为是不同的分片

- 标志：每个比特有不同的含义
   DF（Don't Fragment）位：1表示不允许分片，0表示允许分片
   MF（more fragmen）位：1表示后面还有分片，0表示后面没有分片，这是最后一个分片
   保留位：必须为0

- 片偏移：13bit，用于标识被分片的每一个分段相对于原始数据的位置

- 生存时间(TTL:Time To Live)：8bit 防止IP数据报在网络中永远兜圈

  每经过一个路由器，TTL会减少1，直到变为0则丢弃该包

- 协议(Protocol) ：8bit 标识IP包传输层的上层协议编号

- 首部校验和：16bit 只校验数据报的首部，不校验数据部分。用于确保IP数据报不被破坏

  因为首部校验非常耗时，所以IPv6中路由器不再进行首部校验

- 源地址：32bit（4字节）

- 目标地址：32bit（4字节）

- 可选项：长度可变，不太常用

- 填充：用来填充可变部分，使可变部分长度为4字节（32bit）的整数倍



### 4.8 IPv6首部格式

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210610095359687.png" alt="image-20210610095359687" style="zoom:70%;" />

- IPV6-版本
  与IPv4一样,由4比特构成。IPv6其版本号为6,因此在这个字段上的值为 "6"

- IPV6-通信量类
  相当于1Pv4的TOS (Type Of Service)字段，也由8比特构成。由于TOS在 1Pv4中几乎没有什么建树，未能成为卓有成效的技术，本来计划在1Pv6中删掉这 个字段。不过，出于今后研究的考虑还是保留了该字段。

- IPV6-流标号
  由20比特构成，准备用于服务质量(QoS : Quality Of Service) 控制。使用 这个字段提供怎样的服务已经成为未来研究的课题。不使用QoS时每一位可以全 部设置为0。

  在进行服务质量控制时，将流标号设置为一个随机数，然后利用一种可以设 置流的协议RSVE(Resource Reservation E'rotocol) T在路由器上进行QoS设置。当 某个包在发送途中需要QoS时，需要附上RSVE预想的流标号。路由器接收到这 样的IE包后先将流标号作为查找关键字，迅速从服务质量控制信息中查找并做相 应处理。

  此外，只有流标号、源地址以及目标地址三项完全一致时，才被认为是一 个流。

- IPV6-有效载荷长度
  有效载荷是指包的数据部分。IPv4的TL (Total Length)是指包括首部在内的 所有长度。然而IPv6中的这个Playload Length不包括首部，只表示数据部分的长 度。由于IPv6的可选项是指连接IPv6首部的数据，因此当有可选项时，此处包 含可选项数据的所有长度就是Playload Length。

- IPV6-下一个首部
  相当于IPv4中的协议字段。由8比特构成。通常表示IP的上一层协议是TCP 或UDP。不过在有IPv6扩展首部的情况下，该字段表示后面第一个扩展首部的协 议类型。

- IPV6-跳数限制
  由8比特构成。与IPv4中的TTL意思相同。为了强调”可通过路由器个数” 这个概念，才将名字改成了"Hop Limit"。

  数据每经过一次路由器就减1减到0 则丢弃数据。

- IPV6-源地址
  由128比特(8个16位字节）构成。表示发送端IP地址

- IPV6-目标地址
  由128比特(8个16位字节）构成。表示接收端IP地址。

**IPV6-扩展首部**
IPv6的首部长度固定，无法将可选项加人其中。取而代之的是通过扩展首部 对功能进行了有效扩展。

扩展首部通常介于IPv6首部与TCP/UDP首部中间。在IPv4中可选项长度固 定为40字节，但是在IPv6中没有这样的限制。也就是说，IPv6的扩展首部可以 是任意长度。扩展首部当中还可以包含扩展首部协议以及下一个扩展首部字段。

IPv6首部中没有标识以及标志字段，在需要对IP数据报进行分片时，可以使 用扩展首部。

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210610095651367.png" alt="image-20210610095651367" style="zoom:67%;" />

具体的扩展首部如表所示。当需要对IPv6的数据报进行分片时，可以设 置为扩展域为44 (Fragemant Header)。使用IPsec时，可以使用50、51的ESP、 AH。Mobile IPv6的情况下可以采用60与135的目标地址选项与移动首部。

<img src="E:\frontendStudy\计算机网络\《图解TCPIP》.assets\image-20210610095702892.png" alt="image-20210610095702892" style="zoom:67%;" />